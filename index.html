<!DOCTYPE html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="jquery.csv.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
</head>

<script type="text/javascript">
    google.load('visualization', '49', {});
</script>

<script type="text/javascript">
    function drawCharts() {
        $.get("https://raw.githubusercontent.com/ziglang/gotta-go-fast/master/benchmarks/manifest.json", function (json) {
            const parsed = JSON.parse(json);

            console.log(parsed);
            for (var bench in parsed) {
                if (parsed.hasOwnProperty(bench)) {
                    var elem = document.createElement("div");
                    elem.id = bench + "-std_gpa-chart";
                    document.body.appendChild(elem);
                    var elem2 = document.createElement("div");
                    elem2.id = bench + "-libc-chart";
                    document.body.appendChild(elem2);

                    drawChartForBench(bench, 'std_gpa');
                    drawChartForBench(bench, 'libc');    
                }
            }
        });
    }

    function drawChartForBench(bench, alloc) {
        var query = new google.visualization.Query("https://docs.google.com/spreadsheets/d/1Up7WXdC3cvuHyMq5nKNmTj6pCxH2MxSohAKGuM6zGpg/gviz/tq?sheet=RawData");
        query.setQuery("select D, H / W, S / AH where (B = '" + bench + "') and (C = '" + alloc + "') and E is null");
        query.send(handleQuery);

        function handleQuery(response) {
            if (response.isError()) return;

            var data = response.getDataTable();
            if (data.getValue(0, 0) == null) return;

            data.removeRows(0, data.getNumberOfRows() - 150);

            var wrapper = new google.visualization.ChartWrapper({
                chartType: 'LineChart',
                dataTable: data,
                containerId: bench + "-" + alloc + '-chart',
                options: {
                    title: bench + " - " + alloc,
                    height: 320,
                    titleColor: "#f7a41d",
                    lineWidth: 3,
                    backgroundColor: "#111111",
                    hAxis: {
                        textPosition: "none"
                    },
                    legend: {
                        textStyle: {
                            color: "#ffffff",
                        }
                    },
                    series: {
                        0: {
                            labelInLegend: "wall_time",
                        },
                        1: {
                            labelInLegend: "max_rss",
                        }
                    },
                    tooltip: {
                        isHtml: true,
                        trigger: 'selection',
                    },
                }
            });

            google.visualization.events.addListener(wrapper, 'ready', onReady);

            function onReady() {
                wrapper.getChart().setAction({
                    id: 'tooltip',
                    text: 'Go to Commit',
                    action: function () {
                        selection = wrapper.getChart().getSelection();
                        window.open("https://github.com/ziglang/zig/commit/" + data.getValue(selection[0].row, 0));
                    }
                });
            }

            wrapper.draw();
        }
    }
    google.charts.setOnLoadCallback(drawCharts);
</script>

<style>
    div.google-visualization-tooltip {
        background-color: #222222
    }

    div.google-visualization-tooltip>ul>li>span {
        color: white !important
    }
</style>